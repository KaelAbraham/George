version: "3.9"

services:

  ############################################################
  # FRONTEND — Vite Dev Server with Hot Reload
  ############################################################
  frontend:
    image: node:20
    working_dir: /app
    command: ["npm", "run", "dev", "--", "--host"]
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    environment:
      - VITE_BACKEND_URL=http://localhost:5000/v1/api
    depends_on:
      - backend
    networks:
      - caudexnet

  ############################################################
  # BACKEND — Flask Brain Service (Public API)
  ############################################################
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    command: flask --app app.py run --host=0.0.0.0 --port=5000 --reload
    ports:
      - "5000:5000"
    volumes:
      - ./backend:/app
      - ./persistent_data/backend:/app/backend/data
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
      - AUTH_SERVER_URL=http://auth:6001
      - FILESYSTEM_SERVER_URL=http://filesystem:6002
      - CHROMA_SERVER_URL=http://chroma:6003
      - BILLING_SERVER_URL=http://billing:6004
      - GIT_SERVER_URL=http://git:6005
      - EXTERNAL_DATA_SERVER_URL=http://external_data:6006
    depends_on:
      - auth
      - filesystem
      - chroma
      - billing
      - git
    networks:
      - caudexnet

  ############################################################
  # HAND SERVICES — Internal Only, Accessible Only to Backend
  ############################################################

  auth:
    build:
      context: ./auth_server
      dockerfile: Dockerfile
    command: ["python", "app.py"]
    expose:
      - "6001"
    volumes:
      - ./persistent_data/auth:/app/data
      - ./auth_server:/app
    env_file:
      - ./auth_server/.env
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    networks:
      - caudexnet

  filesystem:
    build:
      context: ./filesystem_server
      dockerfile: Dockerfile
    command: ["python", "app.py"]
    expose:
      - "6002"
    env_file:
      - ./filesystem_server/.env
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      - ./filesystem_server/uploads:/app/uploads
      - ./filesystem_server/projects:/app/projects
      - ./filesystem_server:/app
    networks:
      - caudexnet

  chroma:
    build:
      context: ./chroma_server
      dockerfile: Dockerfile
    command: ["python", "app.py"]
    expose:
      - "6003"
    env_file:
      - ./chroma_server/.env
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      - ./chroma_server/data:/app/data
      - ./chroma_server:/app
    networks:
      - caudexnet

  billing:
    build:
      context: ./billing_server
      dockerfile: Dockerfile
    command: ["python", "app.py"]
    expose:
      - "6004"
    env_file:
      - ./billing_server/.env
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    networks:
      - caudexnet

  git:
    build:
      context: ./git_server
      dockerfile: Dockerfile
    command: ["python", "app.py"]
    expose:
      - "6005"
    env_file:
      - ./git_server/.env
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      - ./git_server/projects:/app/projects
      - ./git_server:/app
    networks:
      - caudexnet

  ############################################################
  # GRAPH DATABASE — Neo4j for Knowledge Graph Storage
  ############################################################
  graph_server:
    image: neo4j:latest
    container_name: graph_server
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - ./persistent_data/graph_db:/data
    environment:
      - NEO4J_AUTH=none
    networks:
      - caudexnet

networks:
  caudexnet:
    driver: bridge
